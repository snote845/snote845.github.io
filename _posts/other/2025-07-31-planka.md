---
layout: post
title: "Planka"
date: 2025-07-31 21:00:00 +0800
categories: [Planka, docker]
tags: [planka, docker]
---

# 一个看板项目-PlanKa
为了找到一个合适的看板，搜索了很多看板工具之后，发现没有合适的自用看板，看文章推荐 Gitee 中 issue 看板很好用，在 PC 网页中试了一下，效果还可以，但是没有移动端的，写了一个 JetpackCompose Demo 测试看板的链接，发现网页不支持移动端自适用。

#### 关于 Jetpack Compose
在使用Jetpack Compose 任务看板测试实现过程中，了解了一下 JetpackCompose 。

JetpackCompose 是 Android 现代力推的框架，主要使用 kotlin 语言与 kotlin 插件，界面由老版本的命令式 UI（xml）转向了声明式 UI，直接在代码中进行界面编写，通过注解 @Compose来声明。这里不过多介绍新老实现差异。

1.jetpack Compose 在框架实现封装方面，主要通过 kotlin 来实现的，所以封装尽量使用 kotlin。

2.使用 TargetSdkVersion 34 之后，应用界面强制默认显示边到边 EdgeToEdge，这会导致界面绘制显示到系统状态栏下面，UI 叠加效果看起来非常难看。那么targetSdkVersion35之后的菜单栏，状态栏在开发中是如何处理的？

Materil Design 3 Scaffold来定义topBar，bottombar，floattingButton 的实现与管理。如果不想要状态栏，而是单纯设置状态栏中的颜色背景，可以使用Modifier 来定义，注意 Modifier 是链式调用，调用顺序的不同将会导致不同的效果。

```bash
//Material Design 提供的 Scaffold和 TopAppBar（或 CenterAlignedTopAppBar, MediumTopAppBar, LargeTopAppBar 等） Composable 函数。
Scaffold(
    topBar = { TopAppBar(...) },
    content = { padding ->
        // padding 包含系统栏的内边距（包括状态栏和导航栏）
        Box(modifier = Modifier.padding(padding)) {
            // 内容布局
        }
    }
)

//Modifier
Column(
            modifier = Modifier
                .background(MaterialTheme.colorScheme.primary)
                .padding(paddingValues) // 关键：将 Scaffold 提供的内边距应用到内容上
                .fillMaxSize()
                //.padding(16.dp) // 额外的内容内边距
        ) {
            WebViewScreen(initialUrl = "https://www.baidu.com/") // 替换为你想加载的 URL
        }
```
很遗憾，移动端打开的 gitee 中的界面效果没有自适应。

在开发者群聊里，有人给我推荐了 planka 这个看板开源项目[https://github.com/plankanban/planka](https://github.com/plankanban/planka)。

部署看效果

1. git clone [https://github.com/plankanban/planka.git](https://github.com/plankanban/planka.git)
2. cd planka && docker-compose -f docker-compose-dev.yml up(需要安装 docker，注意端口号 3000)
3. 没有提供账号注册功能，docker-compose.yml中有提供默认账号配置的功能

```bash
services:
  planka-server:
    environment:
      - DEFAULT_ADMIN_EMAIL=gaorui@example.com
      - DEFAULT_ADMIN_PASSWORD=snote
      - DEFAULT_ADMIN_NAME=snote
      - DEFAULT_ADMIN_USERNAME=snote
```
4. 如何添加其他账号？
   1. 可通过管理员账号在设置中添加
5. 部署与迁移测试
   1. ⚠️由于本地是 mac 环境，脚本是基于 ubuntu，需要调整一下
   2. 最低机器 2G 配置也可以跑
   3. 备份 ./docker-backup.sh

```bash
#!/bin/bash

# Stop on Error
set -e

# 检查 Docker 是否运行
if ! docker info > /dev/null 2>&1; then
    echo "错误: Docker 未运行，请先启动 Docker"
    exit 1
fi

# 自动检测容器名称
POSTGRES_CONTAINER=$(docker ps --format '{{.Names}}' | grep -i 'postgres' | head -n 1)
PLANKA_CONTAINER=$(docker ps --format '{{.Names}}' | grep -i 'planka' | grep -v 'postgres' | head -n 1)

if [ -z "$POSTGRES_CONTAINER" ] || [ -z "$PLANKA_CONTAINER" ]; then
    echo "错误: 找不到运行中的 Planka 容器"
    echo "请确保 Planka 和 Postgres 容器正在运行"
    exit 1
fi

# 设置容器名称
PLANKA_DOCKER_CONTAINER_POSTGRES="$POSTGRES_CONTAINER"
PLANKA_DOCKER_CONTAINER_PLANKA="$PLANKA_CONTAINER"

# 创建临时文件夹
BACKUP_DATETIME=$(date -u +"%Y-%m-%dT%H-%M-%SZ")
BACKUP_DIR="$BACKUP_DATETIME-backup"
mkdir -p "$BACKUP_DIR"

echo "开始备份..."
echo "使用的容器:"
echo "Postgres: $PLANKA_DOCKER_CONTAINER_POSTGRES"
echo "Planka: $PLANKA_DOCKER_CONTAINER_PLANKA"

# Dump DB into SQL File
echo -n "Exporting postgres database ... "
docker exec -t "$PLANKA_DOCKER_CONTAINER_POSTGRES" pg_dumpall -c -U postgres > "$BACKUP_DATETIME-backup/postgres.sql"
echo "Success!"

# Export Docker Voumes
echo -n "Exporting favicons ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$BACKUP_DATETIME-backup:/backup" ubuntu cp -r /app/public/favicons /backup/favicons
echo "Success!"
echo -n "Exporting user-avatars ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$BACKUP_DATETIME-backup:/backup" ubuntu cp -r /app/public/user-avatars /backup/user-avatars
echo "Success!"
echo -n "Exporting background-images ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$BACKUP_DATETIME-backup:/backup" ubuntu cp -r /app/public/background-images /backup/background-images
echo "Success!"
echo -n "Exporting attachments ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$BACKUP_DATETIME-backup:/backup" ubuntu cp -r /app/private/attachments /backup/attachments
echo "Success!"

# Create tgz
echo -n "Creating final tarball $BACKUP_DATETIME-backup.tgz ... "
tar -czf "$BACKUP_DATETIME-backup.tgz" \
    "$BACKUP_DATETIME-backup/postgres.sql" \
    "$BACKUP_DATETIME-backup/favicons" \
    "$BACKUP_DATETIME-backup/user-avatars" \
    "$BACKUP_DATETIME-backup/background-images" \
    "$BACKUP_DATETIME-backup/attachments"
echo "Success!"

#Remove source files
echo -n "Cleaning up temporary files and folders ... "
rm -rf "$BACKUP_DATETIME-backup"
echo "Success!"

echo "Backup Complete!"

```
   4. 恢复账号docker-restore.sh xxx/xx/sql\_file.tgz

```bash
#!/bin/bash

# Stop on Error
set -e

# 检查参数
if [ -z "$1" ]; then
    echo "错误: 未指定备份文件"
    echo "用法: $0 <backup-file.tgz>"
    exit 1
fi

# 检查 Docker 是否运行
if ! docker info > /dev/null 2>&1; then
    echo "错误: Docker 未运行，请先启动 Docker"
    exit 1
fi

# 自动检测容器名称
POSTGRES_CONTAINER=$(docker ps --format '{{.Names}}' | grep -i 'postgres' | head -n 1)
PLANKA_CONTAINER=$(docker ps --format '{{.Names}}' | grep -i 'planka' | grep -v 'postgres' | head -n 1)

if [ -z "$POSTGRES_CONTAINER" ] || [ -z "$PLANKA_CONTAINER" ]; then
    echo "错误: 找不到运行中的 Planka 容器"
    echo "请确保 Planka 和 Postgres 容器正在运行"
    exit 1
fi

# 设置容器名称
PLANKA_DOCKER_CONTAINER_POSTGRES="$POSTGRES_CONTAINER"
PLANKA_DOCKER_CONTAINER_PLANKA="$PLANKA_CONTAINER"

# 提取备份文件
PLANKA_BACKUP_ARCHIVE_TGZ=$1
PLANKA_BACKUP_ARCHIVE=$(basename "$PLANKA_BACKUP_ARCHIVE_TGZ" .tgz)
echo -n "Extracting tarball $PLANKA_BACKUP_ARCHIVE_TGZ ... "
tar -xzf "$PLANKA_BACKUP_ARCHIVE_TGZ"
echo "Success!"

# Import Database
echo -n "Importing postgres database ... "
cat "$PLANKA_BACKUP_ARCHIVE/postgres.sql" | docker exec -i "$PLANKA_DOCKER_CONTAINER_POSTGRES" psql -U postgres
echo "Success!"

# Restore Docker Volumes
echo -n "Importing favicons ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$PLANKA_BACKUP_ARCHIVE:/backup" ubuntu cp -rf /backup/favicons /app/public/
echo "Success!"
echo -n "Importing user-avatars ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$PLANKA_BACKUP_ARCHIVE:/backup" ubuntu cp -rf /backup/user-avatars /app/public/
echo "Success!"
echo -n "Importing background-images ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$PLANKA_BACKUP_ARCHIVE:/backup" ubuntu cp -rf /backup/background-images /app/public/
echo "Success!"
echo -n "Importing attachments ... "
docker run --rm --volumes-from "$PLANKA_DOCKER_CONTAINER_PLANKA" -v "$(pwd)/$PLANKA_BACKUP_ARCHIVE:/backup" ubuntu cp -rf /backup/attachments /app/private/
echo "Success!"

echo -n "Cleaning up temporary files and folders ... "
rm -r "$PLANKA_BACKUP_ARCHIVE"
echo "Success!"

echo "Restore complete!"
```
   5. 将备份文件传输到新服务器:scp 2023-06-01T12-00-00Z-backup.tgz user@new-server:/path/to/planka/
   6. 新的服务器上部署 Planka

```bash
# 克隆仓库或复制配置文件
git clone https://github.com/plankanban/planka.git
cd planka

# 修改docker-compose.yml中的环境变量（如BASE_URL等）
nano docker-compose.yml

# 启动服务
docker compose -f docker-compose-dev.yml up
```
   7. 恢复数据./docker-restore.sh 2023-06-01T12-00-00Z-backup.tgz
6. 因为希望是跨平台的，在手机上也可以自由的添加查看，但我发现在手机端的效果实在是太差劲了，继续找基于此项目的移动端，我在 Github 中搜索到有一个基于此项目的Flutter 开发，但没有任何介绍和说明[https://github.com/rpsouza441/planka\_mobile.git](https://github.com/rpsouza441/planka_mobile.git)
7. 配置 flutter 环境，尝试运行此项目，发现效果不是
8. 技术栈分析
   1. React+Node.js+PostgreSQL

具体技术实现原理有机会再研究，目前的重点不是这个。